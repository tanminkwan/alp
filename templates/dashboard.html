<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>MSA BANK</title>
        <link rel="stylesheet" href="/static/assets/css/bootstrap.min.css" />
		<link rel="stylesheet" href="/static/assets/css/LineIcons.2.0.css" />
		<link rel="stylesheet" href="/static/assets/css/animate.css" />
		<link rel="stylesheet" href="/static/assets/css/tiny-slider.css" />
		<link rel="stylesheet" href="/static/assets/css/glightbox.min.css" />
		<link rel="stylesheet" href="/static/assets/css/main.css" />

	</head>
	
	
	<body>
	
	<div class="container">
	
	
	   <div class="row mt-5">

			<!-- Earnings (Monthly) Card Example -->
			<div class="col-xl-4 col-md-6 mb-4">
				<div class="card border-left-primary shadow h-100 py-2">
					<div class="card-body">
						<div class="row no-gutters align-items-center">
							<div class="col mr-2">
								<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
									누적 거래 금액</div>
								<div class="h5 mb-0 font-weight-bold text-gray-800"><font id="totalTrAmt">40,000</font> 원</div>
							</div>
							<div class="col-auto">
								<i class="fas fa-calendar fa-2x text-gray-300"></i>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Earnings (Monthly) Card Example -->
			<div class="col-xl-4 col-md-6 mb-4">
				<div class="card border-left-success shadow h-100 py-2">
					<div class="card-body">
						<div class="row no-gutters align-items-center">
							<div class="col mr-2">
								<div class="text-xs font-weight-bold text-success text-uppercase mb-1">
									누적 거래 건수</div>
								<div class="h5 mb-0 font-weight-bold text-gray-800"><font id="totalTrCnt">215,000</font> 건</div>
							</div>
							<div class="col-auto">
								<i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
							</div>
						</div>
					</div>
				</div>
			</div>


			<!-- Pending Requests Card Example -->
			<div class="col-xl-4 col-md-6 mb-4">
				<div class="card border-left-warning shadow h-100 py-2">
					<div class="card-body">
						<div class="row no-gutters align-items-center">
							<div class="col mr-2">
								<div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
									참가인원</div>
								<div class="h5 mb-0 font-weight-bold text-gray-800"><font id="currentUserCnt">18</font> 명</div>
							</div>
							<div class="col-auto">
								<i class="fas fa-comments fa-2x text-gray-300"></i>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		
		
		<!-- Content Row -->

		<div class="row">

			<!-- Area Chart -->
			<div class="col-xl-12 col-lg-12">
				<div class="card shadow mb-4">
					<!-- Card Header - Dropdown -->
					<div
						class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
						<h6 class="m-0 font-weight-bold text-primary">가장 많은 거래가 일어난 고객은?</h6>
						
					</div>
					<!-- Card Body -->
					<div class="card-body">
						<div class="chart-area">
							<canvas id="myAreaChart" ></canvas>
						</div>
					</div>
				</div>
			</div>

		</div>		
		
		
	</div>
	
    <!-- ========================= JS here ========================= -->
    <script src="/static/assets/js/bootstrap.min.js"></script>
    <script src="/static/assets/js/Chart.min.js"></script>
	
	
	<script>
	
		const  backgroundColorArr = [
		  'rgba(255, 99, 132, 0.2)',
		  'rgba(255, 159, 64, 0.2)',
		  'rgba(255, 205, 86, 0.2)',
		  'rgba(75, 192, 192, 0.2)',
		  'rgba(54, 162, 235, 0.2)',
		  'rgba(153, 102, 255, 0.2)',
		  'rgba(201, 203, 207, 0.2)'
		];
		
		const borderColorArr =  [
		  'rgb(255, 99, 132)',
		  'rgb(255, 159, 64)',
		  'rgb(255, 205, 86)',
		  'rgb(75, 192, 192)',
		  'rgb(54, 162, 235)',
		  'rgb(153, 102, 255)',
		  'rgb(201, 203, 207)'
		]	
		
		var dataArray = new Array();
		var labelArray = new Array();
		var backgroundColorArray = new Array();
		var borderColorArray = new Array();
		
		var totalTrAmt = 0;
		var totalTrCnt = 0;
		var currentUserCnt = 0;
	
		var chart_obj = null;
	
		function go(){
		
			fetch('/api/v1/opensearch/ranks/{{event_id}}')
			.then(function(response) {
				// 서버 응답 처리
				if (response.ok) {
					return response.json(); // JSON 응답 파싱
				} else {
					throw new Error('GET 요청 실패');
				}
			})
			.then(function(data) {
				// 서버 응답 데이터 처리
				console.log('서버 응답 데이터:', data);
				
				//값 초기화 
		        dataArray = new Array();
		        labelArray = new Array();
		        backgroundColorArray = new Array();
		        borderColorArray = new Array();
		        
		        totalTrAmt = 0;
		        totalTrCnt = 0;
		        currentUserCnt = 0;		

				data.forEach(item=>{
				
					if (item["key"] != ""){
						labelArray.push(item["key"]);
						dataArray.push(item["doc_count"]);
						currentUserCnt ++;
						totalTrAmt += item["deposit_amount"]["value"] + item["withdraw_amount"]["value"];
						totalTrCnt += item["doc_count"];
					}
				
				});
				
				//색상 설정
				var idx = 0;
				for (var i=0; i < dataArray.length; i++){
					if (backgroundColorArr.length == idx) idx = 0;
						backgroundColorArray.push(backgroundColorArr[idx]);
						borderColorArray.push(borderColorArr[idx]);
					
					idx++;
					
				}

				// 상단부 설정
				document.getElementById("totalTrAmt").innerText = numberFormat(totalTrAmt);
				document.getElementById("totalTrCnt").innerText = numberFormat(totalTrCnt);
				document.getElementById("currentUserCnt").innerText = numberFormat(currentUserCnt);
				
				
				
				//그래프 그리기 
				  const ctx = document.getElementById('myAreaChart');
				  
				  if (chart_obj != null){
					chart_obj.destroy();
				  }

				  chart_obj = new Chart(ctx, {
					type: 'bar',
					data: {
					  labels: labelArray,
					  datasets: [{
						label: '# 거래 건수',
						data: dataArray,
						backgroundColor: backgroundColorArray,
						borderColor: borderColorArray,
						borderWidth: 1
					  }]
					},
					options: {
					  scales: {
							yAxes : [ {
								ticks : {
									beginAtZero : true, // 0부터 시작하게 합니다.
									stepSize: 1   // 1 씩 증가하도록 설정합니다.
								}
							} ]
					  }
					}
				  });
				
				  	
				
				
			})
			.catch(function(error) {
				// 오류 처리
				console.error('오류 발생:', error);
			});
		}
	
	
		function numberFormat(number) {
			// 숫자를 문자열로 변환하여 콤마 추가
			return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		//최초 call
		go();

		//5초에 한번씩 호출
		setInterval(go, 5000);
	

			
		
		
		</script>
	
	
	</body>

</html>
