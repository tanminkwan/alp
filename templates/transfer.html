<title>transfer</title>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Selection</title>
</head>
<body>
    <div>
    <label>받으실 분 : </label>
    <select id="accountSelect"></select>
    <button id="refreshButton">Refresh</button>
    </div>
    <div>
    <label>이체 금액 : </label>
    <input type="number" id="transfer_amount" min="0" max="500000" />
    </div>
    <div>
    <button id="transfer">이체 실행</button>
    </div>
    <div id="message">Msg : </div>
</body>
</html>
<script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>

    var event_id="{{event_id}}";    
    var account_id="{{account_id}}";
    var api_accounts='http://localhost:5011/api/v1/accounts/'+event_id
    var api_transfers='http://localhost:5013/api/v1/transfers/'+event_id
    
    let selectedAccountId = null; // Variable to store selected account ID
    
    console.log("account_id : ", account_id)

    document.addEventListener('DOMContentLoaded', function() {
        const accountSelect = document.getElementById('accountSelect');
        const refreshButton = document.getElementById('refreshButton');

        function fetchAccountData() {
            fetch(api_accounts)
                .then(response => response.json())
                .then(data => {
                    updateSelectOptions(data.results);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function updateSelectOptions(results) {
            accountSelect.innerHTML = ''; // Clear existing options

            results.forEach(result => {
                const option = document.createElement('option');
                option.value = result.account_id;
                option.text = result.user_name;
                accountSelect.appendChild(option);
            });
        }

        refreshButton.addEventListener('click', fetchAccountData); // Add event listener to the Refresh button

        accountSelect.addEventListener('change', function() {
            selectedAccountId = this.value; // Update selected account ID when selection changes
            console.log('selectedAccountId : ',selectedAccountId)
        });

        fetchAccountData(); // Fetch data on page load
    });

    $('#transfer').click(function(){
        let transfer_amount = parseInt($('#transfer_amount').val());

        if(!transfer_amount){
			alert("이체금액을 입력해주세요.");
            document.getElementById("transfer_amount").focus();
			return;
        }

        if(!selectedAccountId){
			alert("받으실 분을 선택해 주세요.");
            document.getElementById("accountSelect").focus();
			return;
        }

        let sendData = {
                sender : account_id,
                receiver : selectedAccountId,
                transfer_amount : transfer_amount,
            }

        $.ajax({
			type:'post',
			url: api_transfers,
			data:JSON.stringify(sendData),
            contentType: "application/json; charset=utf-8",
			dataType:'json',
			success : function(data){
				console.log(data.transfer_id)
				$('#message').html("이체가 접수되었습니다. 이체번호 : "+data.message.transfer_id);
				//$('#transfer').attr('disabled', true);
				refreshTransferList();
			}
		});

    });

    function refreshTransferList(){
        return;
    }

</script>